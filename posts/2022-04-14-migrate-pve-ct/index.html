<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>迁移 PVE CT 到 VM - Justin Lei</title><meta name=viewport content="width=device-width,initial-scale=1"><meta itemprop=name content="迁移 PVE CT 到 VM"><meta itemprop=description content="VM 可以直通显卡，CT 不能直通"><meta itemprop=datePublished content="2022-04-14T17:48:07+08:00"><meta itemprop=dateModified content="2022-04-14T17:48:07+08:00"><meta itemprop=wordCount content="186"><meta itemprop=keywords content><meta property="og:title" content="迁移 PVE CT 到 VM"><meta property="og:description" content="VM 可以直通显卡，CT 不能直通"><meta property="og:type" content="article"><meta property="og:url" content="https://lza852.com/posts/2022-04-14-migrate-pve-ct/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-14T17:48:07+08:00"><meta property="article:modified_time" content="2022-04-14T17:48:07+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="迁移 PVE CT 到 VM"><meta name=twitter:description content="VM 可以直通显卡，CT 不能直通"><link href="https://fonts.googleapis.com/css?family=Playfair+Display:700" rel=stylesheet type=text/css><link rel=stylesheet type=text/css media=screen href=https://lza852.com/css/normalize.css><link rel=stylesheet type=text/css media=screen href=https://lza852.com/css/main.css><link id=dark-scheme rel=stylesheet type=text/css href=https://lza852.com/css/dark.css><script src=https://lza852.com/js/feather.min.js></script>
<script src=https://lza852.com/js/main.js></script></head><body><div class="container wrapper"><div class=header><div class=avatar><a href=https://lza852.com/><img src=https://avatars.githubusercontent.com/u/20857777 alt="Justin Lei"></a></div><h1 class=site-title><a href=https://lza852.com/>Justin Lei</a></h1><div class=site-description><p>Study forever</p><nav class="nav social"><ul class=flat><li><a href=https://github.com/zianglei title=Github><i data-feather=github></i></a></li></ul></nav></div><nav class=nav><ul class=flat></ul></nav></div><div class=post><div class=post-header><div class=meta><div class=date><span class=day>14</span>
<span class=rest>Apr 2022</span></div></div><div class=matter><h1 class=title>迁移 PVE CT 到 VM</h1></div></div><div><nav id=TableOfContents><ul><li><a href=#名词定义>名词定义</a></li><li><a href=#迁移步骤>迁移步骤</a><ul><li><a href=#更新-fstab>更新 fstab</a></li></ul></li><li><a href=#安装-grub>安装 grub</a></li></ul></nav></div><hr><div class=markdown><h2 id=名词定义>名词定义</h2><p>CT：运行在 PVE 上要迁移的 ubuntu 源容器</p><p>VM：运行在 PVE 上的目标虚拟机</p><h2 id=迁移步骤>迁移步骤</h2><p>在 PVE 中创建 VM，然后进入 desktop 镜像的 liveCD 模式，对 VM 上的硬盘（我的路径为 /dev/sda）进行分区和格式化。</p><p>默认分区为</p><ul><li>/dev/sda1 为 fat32 文件系统的主分区，可启动，存放 bootloader</li><li>/dev/sda2 为逻辑分区</li><li>/dev/sda5 为 ext4 文件系统格式的 Linux 分区</li></ul><p><img src=fdisk_output.png alt></p><p>使用 fdisk 在 /dev/sda 上按照上述图片格式创建三个分区，并将 /dev/sda1 标记为 bootable （命令 a），然后使用命令格式化分区</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkfs.fat -F 32 /dev/sda1
</span></span><span style=display:flex><span>mkfs.ext4 /dev/sda5
</span></span></code></pre></div><p>更新分区表并格式化之后，将 /dev/sda5 挂载（此处挂载到/mnt)，使用 rsync 将 CT 的内容拷贝到 /mnt/root，参考命令为</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rsync -auHxv –numeric-ids –-exclude=/etc/network/* –-exclude=/proc/* –-exclude=/tmp/* –-exclude=/sys/* –-exclude=/dev/* –-exclude=/mnt/* –-exclude=/boot/* root@SRC-IP:/* /mnt/
</span></span></code></pre></div><p>拷贝完成后，由于原本的 CT 使用的是宿主机的内核，因此拷贝后需要重新下载并安装内核，从而能够被 bootloader 发现，并且需要更新 bootloader 和 fstab，能够正确启动并挂载硬盘。</p><p>要根据 CT 版本下载内核，我的是 ubuntu 21.04，下载了 5.11.0 的内核，可以下载编译好的 deb 包，包括 linux-headers，linux-images-unsigned 和 linux-modules。下载完之后安装 deb 包即可。</p><h3 id=更新-fstab>更新 fstab</h3><p>fstab 文件用于声明启动时要挂载的硬盘分区。首先使用</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>blkid | grep UUID
</span></span></code></pre></div><p>获取 /dev/sda 各个分区的 UUID</p><p><img src=blkid.png alt></p><p>然后创建 /mnt/etc/fstab 文件，按照以下格式写入</p><p><img src=fstab.png alt></p><p>前面两行的 UUID 对应 /dev/sda5 和启动分区 /dev/sda1</p><h2 id=安装-grub>安装 grub</h2><p>首先需要将 liveCD 上的 /dev、/sys、/run、/proc 重新挂载到 /mnt/ 下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo mount /dev /mnt/dev --rbind
</span></span><span style=display:flex><span>sudo mount /sys /mnt/sys --rbind
</span></span><span style=display:flex><span>sudo mount /run /mnt/run --rbind
</span></span><span style=display:flex><span>sudo mount /proc /mnt/proc --rbind
</span></span></code></pre></div><p>在 /mnt/boot 处创建 efi 文件夹，然后将启动分区（此处是 /dev/sda1）挂载到 efi 位置。之后使用</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>chroot /mnt/
</span></span></code></pre></div><p>切换根目录。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install initramfs-tools -y
</span></span><span style=display:flex><span>sudo grub-install
</span></span><span style=display:flex><span>update-initramfs -u -k <span style=color:#a31515>${</span>KERNEL_VERSION<span style=color:#a31515>}</span>
</span></span><span style=display:flex><span>sudo update-grub
</span></span><span style=display:flex><span>sudo mkdir /proc
</span></span></code></pre></div><p>KERNEL_VERSION 指的是安装的内核版本，例如 5.11.0-051100-generic</p><p>grub-install 和 update-grub 命令用于更新 bootloader，之后可以停止 VM，更改 VM 的 boot order，将 scsi0 设为第一优先级。</p><p>最后重启即可从迁移的系统启动。</p></div><div class=tags></div></div></div><div class="footer wrapper"><nav class=nav><div>2022 © Justin Lei | <a href=https://github.com/knadh/hugo-ink>Ink</a> theme on <a href=https://gohugo.io>Hugo</a></div></nav></div><script>feather.replace()</script></body></html>